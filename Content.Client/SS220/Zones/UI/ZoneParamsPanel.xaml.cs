// Â© SS220, An EULA/CLA with a hosting restriction, full text: https://raw.githubusercontent.com/SerbiaStrong-220/space-station-14/master/CLA.txt
using Content.Client.SS220.BoxLayout;
using Content.Client.SS220.Overlays;
using Content.Client.SS220.Zones.Systems;
using Content.Shared.SS220.Maths;
using Content.Shared.SS220.Zones.Components;
using Content.Shared.SS220.Zones.Systems;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using System.Linq;
using System.Numerics;
using static Content.Shared.SS220.Zones.Systems.ZoneParamsState;

namespace Content.Client.SS220.Zones.UI;

[GenerateTypedNameReferences]
public sealed partial class ZoneParamsPanel : PanelContainer
{
    [Dependency] private readonly IEntityManager _entityManager = default!;
    [Dependency] private readonly IBoxLayoutManager _boxLayoutManager = default!;
    private readonly ZonesSystem _zones = default!;

    public Action<ZoneParamsState>? ParamsChanged;

    public Entity<ZoneComponent>? ZoneEntity
    {
        get => _zoneEntity;
        set => SetZoneEntity(value);
    }

    private Entity<ZoneComponent>? _zoneEntity;

    public ZoneParamsState CurParams
    {
        get => _curParams;
        set
        {
            _curParams = value;
            CancelLayout();
            Refresh();
            ParamsChanged?.Invoke(value);
        }
    }

    private ZoneParamsState _curParams;

    public ZoneParamsState OriginalParams => _originalParams;
    private ZoneParamsState _originalParams;

    private BoxLayoutMode _layoutMode = BoxLayoutMode.Adding;

    private BoxesOverlay _overlay;
    private ZoneParamsBoxesOverlayProvider _overlayProvider;

    public ZoneParamsPanel() : this(null) { }

    public ZoneParamsPanel(Entity<ZoneComponent>? entity)
    {
        IoCManager.InjectDependencies(this);
        RobustXamlLoader.Load(this);

        _overlay = BoxesOverlay.GetOverlay();
        _overlayProvider = new ZoneParamsBoxesOverlayProvider(this);

        _zones = _entityManager.System<ZonesSystem>();
        SetZoneEntity(entity);

        SizeOptionsBackground.PanelOverride = new StyleBoxFlat()
        {
            BackgroundColor = new Color(32, 32, 32),
            BorderColor = new Color(128, 128, 128),
            BorderThickness = new Thickness(2)
        };

        AddBoxButton.OnToggled += e =>
        {
            if (e.Pressed)
                StartLayout(BoxLayoutMode.Adding);
            else
                CancelLayout();
        };
        CutBoxButton.OnToggled += e =>
        {
            if (e.Pressed)
                StartLayout(BoxLayoutMode.Cutting);
            else
                CancelLayout();
        };
        ShowChangesButton.OnToggled += e => SetOverlay(e.Pressed);

        NameLineEdit.OnFocusExit += _ => Refresh();
        NameLineEdit.OnTextEntered += args => ChangeCurrentParams((ref ZoneParamsState p) => p.Name = args.Text);

        PrototypeIDLineEdit.OnFocusExit += _ => Refresh();
        PrototypeIDLineEdit.OnTextEntered += args => ChangeCurrentParams((ref ZoneParamsState p) => p.ProtoId = args.Text);

        HexColorLineEdit.OnFocusExit += _ => Refresh();
        HexColorLineEdit.OnTextEntered += args =>
        {
            if (Color.TryParse(args.Text, out var color))
                ChangeCurrentParams((ref ZoneParamsState p) => p.Color = color);
        };

        ContainerNetIDLineEdit.OnFocusExit += _ => Refresh();
        ContainerNetIDLineEdit.OnTextEntered += args =>
        {
            if (NetEntity.TryParse(args.Text, out var netEnt) &&
                _zones.IsValidContainer(_entityManager.GetEntity(netEnt)))
                ChangeCurrentParams((ref ZoneParamsState p) => p.Container = netEnt);
        };

        AttachToGridCheckbox.OnPressed += _ => ChangeCurrentParams((ref ZoneParamsState s) =>
        {
            s.AttachToGrid = AttachToGridCheckbox.Pressed;
            s.RecalculateBoxes();
        });
        CutSpaceCheckbox.OnPressed += _ => ChangeCurrentParams((ref ZoneParamsState s) =>
        {
            s.CutSpace = CutSpaceCheckbox.Pressed;
            s.RecalculateBoxes();
        });
    }

    protected override void ExitedTree()
    {
        RemoveLayoutReact();
        SetOverlay(false);
        base.ExitedTree();
    }

    public ZoneParamsPanel(ZoneParamsState @params) : this(null)
    {
        _curParams = @params;
        Refresh();
    }

    public void Refresh()
    {
        NameLineEdit.Text = CurParams.Name;
        PrototypeIDLineEdit.Text = CurParams.ProtoId;
        HexColorLineEdit.Text = CurParams.Color.ToHex();
        ContainerNetIDLineEdit.Text = CurParams.Container.IsValid() ? CurParams.Container.ToString() : string.Empty;
        AttachToGridCheckbox.Pressed = CurParams.AttachToGrid;
        CutSpaceCheckbox.Pressed = CurParams.CutSpace;

        Box2ListContainer.RemoveAllChildren();
        for (var i = 0; i < CurParams.Boxes.Count; i++)
        {
            var box = CurParams.Boxes[i];
            var entry = new ZoneBoxEntry(box);
            var index = i;
            entry.OnBoxChanged += newBox => ChangeCurrentParams((ref ZoneParamsState s) => s.Boxes[index] = newBox);
            Box2ListContainer.AddChild(entry);
        }

        _overlayProvider.Refresh();
    }

    public void SetZoneEntity(Entity<ZoneComponent>? entity)
    {
        _zoneEntity = entity;
        _originalParams = entity?.Comp.ZoneParams?.GetState() ?? new ZoneParamsState();
        if (string.IsNullOrEmpty(_originalParams.Name))
            _originalParams.Name = $"Zone {_zones.GetZonesCount() + 1}";

        CurParams = _originalParams;
    }

    private void StartLayout(BoxLayoutMode mode)
    {
        if (_boxLayoutManager.Active)
            return;

        _layoutMode = mode;

        switch (mode)
        {
            case BoxLayoutMode.Adding:
                _boxLayoutManager.StartNewBox();
                _boxLayoutManager.AttachToGrid = CurParams.AttachToGrid;
                break;

            case BoxLayoutMode.Cutting:
                _boxLayoutManager.StartNewBox();
                _boxLayoutManager.AttachToGrid = CurParams.AttachToGrid;
                _boxLayoutManager.SetColor(Color.Red);
                break;
        }

        AddLayotReact();
        _boxLayoutManager.SetOverlay(true);
    }

    private void CancelLayout()
    {
        if (!_boxLayoutManager.Active)
            return;

        _boxLayoutManager.Cancel();
    }

    private void AddLayotReact()
    {
        _boxLayoutManager.Ended += OnLayoutEnded;
        _boxLayoutManager.Cancelled += OnLayoutCancelled;
        _boxLayoutManager.SetOverlay(true);
    }

    private void RemoveLayoutReact()
    {
        _boxLayoutManager.Ended -= OnLayoutEnded;
        _boxLayoutManager.Cancelled -= OnLayoutCancelled;
        _boxLayoutManager.SetOverlay(false);

        AddBoxButton.Pressed = false;
        CutBoxButton.Pressed = false;
    }

    private void OnLayoutEnded(BoxLayoutManager.BoxParams @params)
    {
        var newParams = CurParams;
        if (!CurParams.Container.IsValid())
            newParams.Container = @params.Parent;
        else if (@params.Parent != CurParams.Container)
        {
            CancelLayout();
            return;
        }

        var newBoxes = CurParams.Boxes.ToList();
        switch (_layoutMode)
        {
            case BoxLayoutMode.Adding:
                newBoxes.Add(@params.Box);
                break;

            case BoxLayoutMode.Cutting:
                var cutter = @params.Box;
                if (CurParams.AttachToGrid)
                    _zones.AttachToGrid(CurParams.Container, ref cutter);

                newBoxes = MathHelperExtensions.SubstructBox(newBoxes, cutter).ToList();
                break;
        }

        newBoxes = newBoxes.Select(b =>
        {
            var x1 = MathF.Round(b.BottomLeft.X, 2);
            var y1 = MathF.Round(b.BottomLeft.Y, 2);
            var x2 = MathF.Round(b.TopRight.X, 2);
            var y2 = MathF.Round(b.TopRight.Y, 2);
            return Box2.FromTwoPoints(new Vector2(x1, y1), new Vector2(x2, y2));
        }).ToList();

        newParams.Boxes = newBoxes;
        newParams.RecalculateBoxes();
        CurParams = newParams;
    }

    private void OnLayoutCancelled()
    {
        RemoveLayoutReact();
        _boxLayoutManager.SetOverlay(false);
    }

    private (EntityUid Parent, List<Box2> Boxes) GetAddedBoxes()
    {
        var parent = _entityManager.GetEntity(CurParams.Container);
        var result = CurParams.Boxes.ToList();
        if (parent == _entityManager.GetEntity(_originalParams.Container))
            foreach (var box in _originalParams.Boxes)
                result = MathHelperExtensions.SubstructBox(result, box).ToList();

        return (parent, result);
    }

    private (EntityUid Parent, List<Box2> Boxes) GetDeletedBoxes()
    {
        var parent = _entityManager.GetEntity(_originalParams.Container);
        var result = _originalParams.Boxes.ToList();
        if (parent == _entityManager.GetEntity(CurParams.Container))
            foreach (var box in CurParams.Boxes)
                result = MathHelperExtensions.SubstructBox(result, box).ToList();

        return (parent, result);
    }

    public ZoneParamsState GetParams()
    {
        return CurParams;
    }

    public void SetOverlay(bool enabled)
    {
        ShowChangesButton.Pressed = enabled;
        if (enabled)
            _overlay.AddProvider(_overlayProvider);
        else
            _overlay.RemoveProvider(_overlayProvider);
    }

    private void ChangeCurrentParams(ActionRefZoneParams action)
    {
        var @params = CurParams;
        action.Invoke(ref @params);
        CurParams = @params;
    }

    private enum BoxLayoutMode
    {
        Adding,
        Cutting
    }

    private sealed class ZoneParamsBoxesOverlayProvider : BoxesOverlay.BoxesOverlayProvider
    {
        [Dependency] private readonly IEntityManager _entityManager = default!;

        private ZoneParamsPanel _panel;
        private (EntityUid Parent, List<Box2> Boxes) _addedBoxes = new();
        private (EntityUid Parent, List<Box2> Boxes) _deletedBoxes = new();

        private const float ColorAlpha = 0.5f;

        public ZoneParamsBoxesOverlayProvider(ZoneParamsPanel panel) : base()
        {
            _panel = panel;
        }

        public void Refresh()
        {
            _addedBoxes = _panel.GetAddedBoxes();
            _deletedBoxes = _panel.GetDeletedBoxes();
        }

        public override List<BoxesOverlay.BoxesData> GetBoxesDatas()
        {
            var result = new List<BoxesOverlay.BoxesData>();

            if (_addedBoxes.Boxes.Count > 0 && _addedBoxes.Parent.IsValid())
            {
                var data = new BoxesOverlay.BoxesData(_addedBoxes.Parent);
                data.Boxes = _addedBoxes.Boxes;
                data.Color = Color.Green.WithAlpha(ColorAlpha);
                result.Add(data);
            }

            if (_deletedBoxes.Boxes.Count > 0 && _deletedBoxes.Parent.IsValid())
            {
                var data = new BoxesOverlay.BoxesData(_deletedBoxes.Parent);
                data.Boxes = _deletedBoxes.Boxes;
                data.Color = Color.Red.WithAlpha(ColorAlpha);
                result.Add(data);
            }

            return result;
        }
    }
}
